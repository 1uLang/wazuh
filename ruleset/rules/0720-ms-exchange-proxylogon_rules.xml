<!--
  -  Microsoft Exchange proxylogon rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->

<group name="ms,exchange,">

    <!--
    Sample: {"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385F-C22A-43E0-BF4C-06F5698FFBD9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-03-26T18:28:37.194586400Z","eventRecordID":"1521","processID":"12768","threadID":"12156","channel":"Microsoft-Windows-Sysmon/Operational","computer":"WIN-03FGEGKLSPR.fakecorp.com","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: -\r\nUtcTime: 2021-03-26 18:28:37.194\r\nProcessGuid: {F5960AB9-27D5-605E-A501-000000002000}\r\nProcessId: 7496\r\nImage: C:\\\\Windows\\\\System32\\\\cmd.exe\r\nFileVersion: 6.1.7601.17514 (win7sp1_rtm.101119-1850)\r\nDescription: Windows Command Processor\r\nProduct: Microsoft速 Windows速 Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: Cmd.Exe\r\nCommandLine: C:\\\\Windows\\\\system32\\\\cmd.exe\r\nCurrentDirectory: c:\\\\windows\\\\system32\\\\inetsrv\\\\r\nUser: NT AUTHORITY\\\\SYSTEM\r\nLogonGuid: {F5960AB9-F5C7-605D-E703-000000000000}\r\nLogonId: 0x3e7\r\nTerminalSessionId: 0\r\nIntegrityLevel: System\r\nHashes: SHA256=DB06C3534964E3FC79D2763144BA53742D7FA250CA336F4A0FE724B75AAFF386\r\nParentProcessGuid: {F5960AB9-FF45-605D-0C01-000000002000}\r\nParentProcessId: 11416\r\nParentImage: C:\\Program Files\\Microsoft\\Exchange Server\\V15\\Bin\\UMWorkerProcess.exe\r\nParentCommandLine: \"UMWorkerProcess.exe\""},"eventdata":{"utcTime":"2021-03-26 18:28:37.194","processGuid":"{F5960AB9-27D5-605E-A501-000000002000}","processId":"7496","image":"C:\\\\\\\\Windows\\\\\\\\System32\\\\\\\\cmd.exe","fileVersion":"6.1.7601.17514 (win7sp1_rtm.101119-1850)","description":"Windows Command Processor","product":"Microsoft速 Windows速 Operating System","company":"Microsoft Corporation","originalFileName":"Cmd.Exe","commandLine":"C:\\\\\\\\Windows\\\\\\\\system32\\\\\\\\cmd.exe","currentDirectory":"c:\\\\\\\\windows\\\\\\\\system32\\\\\\\\inetsrv\\\\\\\\","user":"NT AUTHORITY\\\\\\\\SYSTEM","logonGuid":"{F5960AB9-F5C7-605D-E703-000000000000}","logonId":"0x3e7","terminalSessionId":"0","integrityLevel":"System","hashes":"SHA256=DB06C3534964E3FC79D2763144BA53742D7FA250CA336F4A0FE724B75AAFF386","parentProcessGuid":"{F5960AB9-FF45-605D-0C01-000000002000}","parentProcessId":"11416","parentImage":"C:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V15\\Bin\\\\UMWorkerProcess.exe","parentCommandLine":"UMWorkerProcess.exe"}}
    -->
    <rule id="61644" level="12">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.parentImage">\\UMWorkerProcess.exe</field>
        <field name="win.eventdata.originalFileName" negate="yes">werfault.exe|wermgr.exe</field>
        <description>UMWorkerProcess.exe spawned unexpected processes. Possible malicious activity</description>
    </rule>

    <rule id="61645" level="12">
        <if_group>sysmon_event_11</if_group>
        <field name="win.eventdata.image">\\UMWorkerProcess.exe</field>
        <field name="win.eventdata.targetFilename" negate="yes">CacheCleanup.bin$|.txt$|.log$|.cfg$|cleanup.bin$</field>
        <description>UMWorkerProcess.exe spawned creating abnormal files. Possible malicious activity</description>
    </rule>

</group>